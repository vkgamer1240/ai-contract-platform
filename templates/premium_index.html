<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Contract Analysis Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-tab.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: 600;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .content-area {
            background: white;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea.form-control {
            min-height: 200px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .sample-contracts {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .sample-card {
            flex: 1;
            min-width: 250px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sample-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .sample-card.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .sample-card h4 {
            color: #667eea;
            margin-bottom: 8px;
        }

        .results-area {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .results-area.error {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .results-area.success {
            border-left-color: #28a745;
            background: #f0fff4;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .risk-score {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 12px;
        }

        .risk-high {
            background: #dc3545;
            color: white;
        }

        .risk-medium {
            background: #ffc107;
            color: #212529;
        }

        .risk-low {
            background: #28a745;
            color: white;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .comparison-table th {
            background: #667eea;
            color: white;
        }

        .compliance-score {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }

        .compliance-bar {
            flex: 1;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            margin-left: 15px;
            overflow: hidden;
        }

        .compliance-fill {
            height: 100%;
            background: linear-gradient(45deg, #28a745, #20c997);
            transition: width 0.5s ease;
        }

        .batch-contract {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .batch-contract h5 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .feature-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
        }

        .feature-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #667eea;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: #28a745;
        }

        .status-offline {
            background: #dc3545;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }

            .nav-tab {
                text-align: center;
            }

            .two-column {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Premium Contract Analysis Platform</h1>
            <p>Advanced AI-powered contract analysis with CUAD + Groq integration</p>
            <div style="margin-top: 15px;">
                <span class="status-indicator status-online" id="statusIndicator"></span>
                <span id="statusText">System Ready</span>
                <span style="margin-left: 20px;">
                    <span class="status-indicator" id="groqStatus"></span>
                    <span id="groqText">Checking Groq API...</span>
                </span>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="openTab('single-analysis')">üìÑ Single Analysis</button>
            <button class="nav-tab" onclick="openTab('batch-analysis')">üìö Batch Processing</button>
            <button class="nav-tab" onclick="openTab('comparison')">‚öñÔ∏è Contract Comparison</button>
            <button class="nav-tab" onclick="openTab('compliance')">‚úÖ Compliance Check</button>
            <button class="nav-tab" onclick="openTab('risk-assessment')">üö® Risk Assessment</button>
        </div>

        <div class="content-area">
            <!-- Single Analysis Tab -->
            <div id="single-analysis" class="tab-content active">
                <h2>üìÑ Single Contract Analysis</h2>
                <p>Comprehensive analysis of individual contracts using CUAD + Groq AI</p>

                <div class="form-group">
                    <label>Sample Contracts (Click to load):</label>
                    <div class="sample-contracts" id="sampleContracts">
                        <!-- Sample contracts will be loaded here -->
                    </div>
                </div>

                <div class="form-group">
                    <label for="singleContractName">Contract Name:</label>
                    <input type="text" id="singleContractName" class="form-control" placeholder="Enter contract name">
                </div>

                <div class="form-group">
                    <label for="singleContractText">Contract Text:</label>
                    <div style="position: relative;">
                        <textarea id="singleContractText" class="form-control" placeholder="Paste your contract text here or use voice input..."></textarea>
                        <button type="button" onclick="startVoiceInput('singleContractText')" 
                                style="position: absolute; top: 10px; right: 10px; background: #667eea; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px;" 
                                title="Voice Input">
                            üé§
                        </button>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="analyzeSingle()">üîç Analyze Contract</button>
                <button class="btn btn-secondary" onclick="clearSingle()">üóëÔ∏è Clear</button>

                <div id="singleResults"></div>
            </div>

            <!-- Batch Analysis Tab -->
            <div id="batch-analysis" class="tab-content">
                <h2>üìö Batch Contract Processing</h2>
                <p>Analyze multiple contracts simultaneously with comparative insights</p>

                <div class="form-group">
                    <button class="btn btn-success" onclick="addBatchContract()">‚ûï Add Contract</button>
                    <button class="btn btn-warning" onclick="loadSampleBatch()">üìã Load Sample Batch</button>
                    <button class="btn btn-info" onclick="clearBatch()">üóëÔ∏è Clear All</button>
                </div>

                <div id="batchContracts">
                    <!-- Batch contracts will be added here -->
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="analyzeBatch()">üîÑ Analyze Batch</button>
                </div>

                <div id="batchResults"></div>
            </div>

            <!-- Contract Comparison Tab -->
            <div id="comparison" class="tab-content">
                <h2>‚öñÔ∏è Contract Comparison</h2>
                <p>Side-by-side comparison of two contracts with risk analysis</p>

                <div class="two-column">
                    <div>
                        <h4>Contract A</h4>
                        <div class="form-group">
                            <label for="contractA_name">Name:</label>
                            <input type="text" id="contractA_name" class="form-control" placeholder="Contract A Name">
                        </div>
                        <div class="form-group">
                            <label for="contractA_text">Text:</label>
                            <textarea id="contractA_text" class="form-control" placeholder="Contract A text..."></textarea>
                        </div>
                    </div>
                    <div>
                        <h4>Contract B</h4>
                        <div class="form-group">
                            <label for="contractB_name">Name:</label>
                            <input type="text" id="contractB_name" class="form-control" placeholder="Contract B Name">
                        </div>
                        <div class="form-group">
                            <label for="contractB_text">Text:</label>
                            <textarea id="contractB_text" class="form-control" placeholder="Contract B text..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <button class="btn btn-primary" onclick="compareContracts()">‚öñÔ∏è Compare Contracts</button>
                    <button class="btn btn-secondary" onclick="loadComparisonSamples()">üìã Load Sample Comparison</button>
                    <button class="btn btn-secondary" onclick="clearComparison()">üóëÔ∏è Clear</button>
                </div>

                <div id="comparisonResults"></div>
            </div>

            <!-- Compliance Check Tab -->
            <div id="compliance" class="tab-content">
                <h2>‚úÖ App Store Compliance Check</h2>
                <p>Check app/software agreements for iOS App Store and Google Play compliance</p>

                <div class="form-group">
                    <label for="complianceContractText">Contract/Agreement Text:</label>
                    <textarea id="complianceContractText" class="form-control" placeholder="Paste your app agreement, terms of service, or privacy policy..."></textarea>
                </div>

                <div class="form-group">
                    <label>Platform to Check:</label>
                    <div>
                        <label><input type="radio" name="platform" value="both" checked> Both iOS & Android</label>
                        <label style="margin-left: 20px;"><input type="radio" name="platform" value="ios"> iOS Only</label>
                        <label style="margin-left: 20px;"><input type="radio" name="platform" value="android"> Android Only</label>
                    </div>
                </div>

                <div class="form-group">
                    <button class="btn btn-primary" onclick="checkCompliance()">‚úÖ Check Compliance</button>
                    <button class="btn btn-warning" onclick="loadComplianceSample()">üì± Load App Sample</button>
                    <button class="btn btn-secondary" onclick="clearCompliance()">üóëÔ∏è Clear</button>
                </div>

                <div id="complianceResults"></div>
            </div>

            <!-- Risk Assessment Tab -->
            <div id="risk-assessment" class="tab-content">
                <h2>üö® Advanced Risk Assessment</h2>
                <p>Detailed risk analysis with scoring and recommendations</p>

                <div class="form-group">
                    <label for="riskContractText">Contract Text:</label>
                    <textarea id="riskContractText" class="form-control" placeholder="Paste your contract for detailed risk analysis..."></textarea>
                </div>

                <div class="form-group">
                    <button class="btn btn-primary" onclick="assessRisk()">üö® Assess Risks</button>
                    <button class="btn btn-warning" onclick="loadRiskSample()">‚ö†Ô∏è Load High-Risk Sample</button>
                    <button class="btn btn-secondary" onclick="clearRisk()">üóëÔ∏è Clear</button>
                </div>

                <div id="riskResults"></div>
            </div>
        </div>
    </div>

    <!-- Modal for detailed results -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        let sampleContracts = [];
        let batchContractCount = 0;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            checkSystemHealth();
            loadSampleContracts();
        });

        // System health check
        async function checkSystemHealth() {
            try {
                const response = await fetch('/api/health_check');
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    document.getElementById('statusIndicator').className = 'status-indicator status-online';
                    document.getElementById('statusText').textContent = 'System Ready';
                } else {
                    document.getElementById('statusIndicator').className = 'status-indicator status-offline';
                    document.getElementById('statusText').textContent = 'System Error';
                }

                if (data.groq_available) {
                    document.getElementById('groqStatus').className = 'status-indicator status-online';
                    document.getElementById('groqText').textContent = 'Groq API Available';
                } else {
                    document.getElementById('groqStatus').className = 'status-indicator status-offline';
                    document.getElementById('groqText').textContent = 'Groq API Not Configured';
                }
            } catch (error) {
                document.getElementById('statusIndicator').className = 'status-indicator status-offline';
                document.getElementById('statusText').textContent = 'Connection Error';
            }
        }

        // Load sample contracts
        async function loadSampleContracts() {
            try {
                const response = await fetch('/api/get_sample_contracts');
                const data = await response.json();
                sampleContracts = data.samples;
                
                const container = document.getElementById('sampleContracts');
                container.innerHTML = '';
                
                sampleContracts.forEach(contract => {
                    const card = document.createElement('div');
                    card.className = 'sample-card';
                    card.onclick = () => loadSampleContract(contract);
                    
                    card.innerHTML = `
                        <h4>${contract.name}</h4>
                        <p><strong>Type:</strong> ${contract.type}</p>
                        <p>Click to load in editor</p>
                    `;
                    
                    container.appendChild(card);
                });
            } catch (error) {
                console.error('Failed to load sample contracts:', error);
            }
        }

        // Load a sample contract
        function loadSampleContract(contract) {
            document.getElementById('singleContractName').value = contract.name;
            document.getElementById('singleContractText').value = contract.text;
            
            // Highlight selected card
            document.querySelectorAll('.sample-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.sample-card').classList.add('selected');
        }

        // Tab functionality
        function openTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Single contract analysis
        async function analyzeSingle() {
            const contractName = document.getElementById('singleContractName').value || 'Unnamed Contract';
            const contractText = document.getElementById('singleContractText').value;
            
            if (!contractText.trim()) {
                alert('Please enter contract text');
                return;
            }
            
            showLoading('singleResults', 'Analyzing contract...');
            
            try {
                const response = await fetch('/api/analyze_single', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contract_text: contractText,
                        contract_name: contractName
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displaySingleResults(data);
                } else {
                    showError('singleResults', data.error);
                }
            } catch (error) {
                showError('singleResults', 'Analysis failed: ' + error.message);
            }
        }

        // Display single analysis results
        function displaySingleResults(data) {
            const analysis = data.analysis;
            const riskScore = analysis.risk_assessment?.risk_score || 0;
            const riskLevel = getRiskLevel(riskScore);
            
            // Store contract text and analysis for enhancement
            window.currentContractText = data.contract_text || document.getElementById('singleContractText').value;
            window.currentAnalysis = analysis;
            
            const html = `
                <div class="results-area success">
                    <h3>üìä Analysis Results: ${data.contract_name}</h3>
                    
                    <div style="margin: 20px 0;">
                        <h4>Risk Assessment</h4>
                        <div style="display: flex; align-items: center; margin: 10px 0;">
                            <span>Risk Score: ${riskScore}/100</span>
                            <span class="risk-score risk-${riskLevel.toLowerCase()}" style="margin-left: 15px;">${riskLevel} Risk</span>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4>Contract Type: ${analysis.contract_type || 'General'}</h4>
                    </div>

                    ${analysis.risk_assessment?.high_risk?.length ? `
                        <div style="margin: 20px 0;">
                            <h4 style="color: #dc3545;">üö® High Risk Issues</h4>
                            <ul>
                                ${analysis.risk_assessment.high_risk.map(risk => `<li>${risk}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    ${analysis.risk_assessment?.medium_risk?.length ? `
                        <div style="margin: 20px 0;">
                            <h4 style="color: #ffc107;">‚ö° Medium Risk Issues</h4>
                            <ul>
                                ${analysis.risk_assessment.medium_risk.map(risk => `<li>${risk}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    ${analysis.groq_analysis?.analysis ? `
                        <div style="margin: 20px 0;">
                            <h4>ü§ñ AI Legal Analysis</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; white-space: pre-wrap;">${analysis.groq_analysis.analysis}</div>
                        </div>
                    ` : ''}

                    <div style="margin: 20px 0;">
                        <button class="btn btn-info" onclick="showDetailedReport('${data.contract_name}', '${encodeURIComponent(JSON.stringify(analysis))}')">üìã View Detailed Report</button>
                        <button class="btn btn-success" onclick="exportReport('${data.contract_name}', '${encodeURIComponent(JSON.stringify(analysis))}')">üíæ Export Report</button>
                        <button class="btn btn-warning" onclick="showAccuracyAssessment()" style="margin-left: 10px;">üéØ Accuracy Assessment</button>
                        <button class="btn btn-primary" onclick="enhanceContract()" style="margin-left: 10px;">‚ú® Enhance</button>
                    </div>
                    
                    <div id="accuracyAssessment" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8;">
                        <!-- Accuracy assessment content will be loaded here -->
                    </div>
                    
                    <div id="contractEnhancement" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #6f42c1;">
                        <!-- Enhanced contract content will be loaded here -->
                    </div>
                </div>
            `;
            
            document.getElementById('singleResults').innerHTML = html;
        }

        // Batch analysis functions
        function addBatchContract() {
            batchContractCount++;
            const container = document.getElementById('batchContracts');
            
            const contractDiv = document.createElement('div');
            contractDiv.className = 'batch-contract';
            contractDiv.id = `batch-contract-${batchContractCount}`;
            
            contractDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h5>Contract ${batchContractCount}</h5>
                    <button class="btn btn-secondary" onclick="removeBatchContract(${batchContractCount})" style="padding: 5px 10px; font-size: 12px;">Remove</button>
                </div>
                <div class="form-group">
                    <label>Contract Name:</label>
                    <input type="text" class="form-control batch-name" placeholder="Contract name">
                </div>
                <div class="form-group">
                    <label>Contract Text:</label>
                    <textarea class="form-control batch-text" placeholder="Contract text..."></textarea>
                </div>
            `;
            
            container.appendChild(contractDiv);
        }

        function removeBatchContract(id) {
            const element = document.getElementById(`batch-contract-${id}`);
            if (element) {
                element.remove();
            }
        }

        function loadSampleBatch() {
            clearBatch();
            
            // Add three sample contracts
            for (let i = 0; i < 3 && i < sampleContracts.length; i++) {
                addBatchContract();
                const contractDiv = document.getElementById(`batch-contract-${batchContractCount}`);
                contractDiv.querySelector('.batch-name').value = sampleContracts[i].name;
                contractDiv.querySelector('.batch-text').value = sampleContracts[i].text;
            }
        }

        function clearBatch() {
            document.getElementById('batchContracts').innerHTML = '';
            document.getElementById('batchResults').innerHTML = '';
            batchContractCount = 0;
        }

        async function analyzeBatch() {
            const contracts = [];
            
            document.querySelectorAll('.batch-contract').forEach(contractDiv => {
                const name = contractDiv.querySelector('.batch-name').value;
                const text = contractDiv.querySelector('.batch-text').value;
                
                if (name.trim() && text.trim()) {
                    contracts.push({ name: name.trim(), text: text.trim() });
                }
            });
            
            if (contracts.length === 0) {
                alert('Please add at least one contract');
                return;
            }
            
            showLoading('batchResults', `Analyzing ${contracts.length} contracts...`);
            
            try {
                const response = await fetch('/api/batch_analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contracts })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displayBatchResults(data.batch_results);
                } else {
                    showError('batchResults', data.error);
                }
            } catch (error) {
                showError('batchResults', 'Batch analysis failed: ' + error.message);
            }
        }

        function displayBatchResults(results) {
            const summary = results.batch_summary;
            
            let html = `
                <div class="results-area success">
                    <h3>üìä Batch Analysis Results</h3>
                    
                    <div style="margin: 20px 0;">
                        <h4>Summary</h4>
                        <p><strong>Total Contracts:</strong> ${summary.total_contracts}</p>
                        <p><strong>High Risk:</strong> ${summary.high_risk_count}</p>
                        <p><strong>Medium Risk:</strong> ${summary.medium_risk_count}</p>
                        <p><strong>Low Risk:</strong> ${summary.low_risk_count}</p>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4>Individual Results</h4>
            `;
            
            results.individual_results.forEach(result => {
                const riskLevel = result.risk_level;
                html += `
                    <div style="border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; margin: 10px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h5>${result.name}</h5>
                            <span class="risk-score risk-${riskLevel.toLowerCase()}">${riskLevel} Risk</span>
                        </div>
                        <p><strong>Score:</strong> ${result.analysis.risk_assessment?.risk_score || 0}/100</p>
                        <p><strong>Type:</strong> ${result.analysis.contract_type || 'General'}</p>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            document.getElementById('batchResults').innerHTML = html;
        }

        // Contract comparison functions
        function loadComparisonSamples() {
            if (sampleContracts.length >= 2) {
                document.getElementById('contractA_name').value = sampleContracts[0].name;
                document.getElementById('contractA_text').value = sampleContracts[0].text;
                document.getElementById('contractB_name').value = sampleContracts[1].name;
                document.getElementById('contractB_text').value = sampleContracts[1].text;
            }
        }

        function clearComparison() {
            document.getElementById('contractA_name').value = '';
            document.getElementById('contractA_text').value = '';
            document.getElementById('contractB_name').value = '';
            document.getElementById('contractB_text').value = '';
            document.getElementById('comparisonResults').innerHTML = '';
        }

        async function compareContracts() {
            const contract1 = {
                name: document.getElementById('contractA_name').value || 'Contract A',
                text: document.getElementById('contractA_text').value
            };
            
            const contract2 = {
                name: document.getElementById('contractB_name').value || 'Contract B',
                text: document.getElementById('contractB_text').value
            };
            
            if (!contract1.text.trim() || !contract2.text.trim()) {
                alert('Please enter text for both contracts');
                return;
            }
            
            showLoading('comparisonResults', 'Comparing contracts...');
            
            try {
                const response = await fetch('/api/compare_contracts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contract1, contract2 })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displayComparisonResults(data.comparison);
                } else {
                    showError('comparisonResults', data.error);
                }
            } catch (error) {
                showError('comparisonResults', 'Comparison failed: ' + error.message);
            }
        }

        function displayComparisonResults(comparison) {
            const summary = comparison.comparison_summary;
            const riskComparison = summary.risk_comparison;
            
            const html = `
                <div class="results-area success">
                    <h3>‚öñÔ∏è Contract Comparison Results</h3>
                    
                    <div style="margin: 20px 0;">
                        <h4>Risk Comparison</h4>
                        <p><strong>Contract A Risk Score:</strong> ${riskComparison.risk_scores.contract_1}/100</p>
                        <p><strong>Contract B Risk Score:</strong> ${riskComparison.risk_scores.contract_2}/100</p>
                        <p><strong>Risk Difference:</strong> ${riskComparison.risk_scores.difference} points</p>
                    </div>

                    ${riskComparison.common_risks?.length ? `
                        <div style="margin: 20px 0;">
                            <h4>Common Risks</h4>
                            <ul>
                                ${riskComparison.common_risks.map(risk => `<li>${risk}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    ${summary.recommendations?.length ? `
                        <div style="margin: 20px 0;">
                            <h4>Recommendations</h4>
                            <ul>
                                ${summary.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('comparisonResults').innerHTML = html;
        }

        // Compliance check functions
        function loadComplianceSample() {
            const appSample = sampleContracts.find(c => c.type === 'app_agreement');
            if (appSample) {
                document.getElementById('complianceContractText').value = appSample.text;
            }
        }

        function clearCompliance() {
            document.getElementById('complianceContractText').value = '';
            document.getElementById('complianceResults').innerHTML = '';
        }

        async function checkCompliance() {
            const contractText = document.getElementById('complianceContractText').value;
            const platform = document.querySelector('input[name="platform"]:checked').value;
            
            if (!contractText.trim()) {
                alert('Please enter contract text');
                return;
            }
            
            showLoading('complianceResults', 'Checking compliance...');
            
            try {
                const response = await fetch('/api/check_compliance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contract_text: contractText,
                        platform: platform
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displayComplianceResults(data.compliance);
                } else {
                    showError('complianceResults', data.error);
                }
            } catch (error) {
                showError('complianceResults', 'Compliance check failed: ' + error.message);
            }
        }

        function displayComplianceResults(compliance) {
            let html = `
                <div class="results-area success">
                    <h3>‚úÖ Compliance Check Results</h3>
                    <p><strong>Overall Score:</strong> ${compliance.compliance_score.toFixed(1)}%</p>
            `;
            
            Object.entries(compliance.platform_analysis).forEach(([platform, analysis]) => {
                html += `
                    <div style="margin: 20px 0;">
                        <h4>${platform.toUpperCase()} Compliance</h4>
                        <div class="compliance-score">
                            <span>Score: ${analysis.compliance_score.toFixed(1)}%</span>
                            <div class="compliance-bar">
                                <div class="compliance-fill" style="width: ${analysis.compliance_score}%"></div>
                            </div>
                        </div>
                        <p><strong>Required Found:</strong> ${analysis.required_found}/${analysis.required_total}</p>
                        <p><strong>Prohibited Content:</strong> ${analysis.prohibited_found} issues</p>
                        
                        ${analysis.issues?.length ? `
                            <div style="margin-top: 10px;">
                                <h5>Issues:</h5>
                                <ul>
                                    ${analysis.issues.map(issue => `<li>${issue}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            // Add Accuracy Assessment Button
            html += `
                <div style="margin-top: 30px; text-align: center;">
                    <button class="btn btn-info" onclick="showAccuracyAssessment()" style="background: #17a2b8; color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer;">
                        üéØ Accuracy Assessment
                    </button>
                </div>
                <div id="accuracyAssessment" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8;">
                    <!-- Accuracy assessment content will be loaded here -->
                </div>
            `;
            
            html += '</div>';
            document.getElementById('complianceResults').innerHTML = html;
        }

        // Risk assessment functions
        function loadRiskSample() {
            // Load a sample that typically has high risk
            const riskySample = sampleContracts.find(c => c.name.includes('Game') || c.name.includes('Social'));
            if (riskySample) {
                document.getElementById('riskContractText').value = riskySample.text;
            }
        }

        function clearRisk() {
            document.getElementById('riskContractText').value = '';
            document.getElementById('riskResults').innerHTML = '';
        }

        async function assessRisk() {
            const contractText = document.getElementById('riskContractText').value;
            
            if (!contractText.trim()) {
                alert('Please enter contract text');
                return;
            }
            
            showLoading('riskResults', 'Assessing risks...');
            
            try {
                const response = await fetch('/api/risk_assessment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contract_text: contractText })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displayRiskResults(data);
                } else {
                    showError('riskResults', data.error);
                }
            } catch (error) {
                showError('riskResults', 'Risk assessment failed: ' + error.message);
            }
        }

        function displayRiskResults(data) {
            const risk = data.risk_assessment;
            const riskLevel = getRiskLevel(risk.risk_score);
            
            let html = `
                <div class="results-area success">
                    <h3>üö® Risk Assessment Results</h3>
                    
                    <div style="margin: 20px 0;">
                        <div style="display: flex; align-items: center; margin: 10px 0;">
                            <span>Overall Risk Score: ${risk.risk_score}/100</span>
                            <span class="risk-score risk-${riskLevel.toLowerCase()}" style="margin-left: 15px;">${riskLevel} Risk</span>
                        </div>
                        <p><strong>Contract Type:</strong> ${data.contract_type}</p>
                    </div>
            `;
            
            if (risk.high_risk?.length) {
                html += `
                    <div style="margin: 20px 0;">
                        <h4 style="color: #dc3545;">üö® High Risk Issues</h4>
                        <ul>
                            ${risk.high_risk.map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            if (risk.medium_risk?.length) {
                html += `
                    <div style="margin: 20px 0;">
                        <h4 style="color: #ffc107;">‚ö° Medium Risk Issues</h4>
                        <ul>
                            ${risk.medium_risk.map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            if (risk.red_flags?.length) {
                html += `
                    <div style="margin: 20px 0;">
                        <h4 style="color: #dc3545;">üö© Red Flags</h4>
                        <ul>
                            ${risk.red_flags.map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            if (data.groq_analysis?.analysis) {
                html += `
                    <div style="margin: 20px 0;">
                        <h4>ü§ñ AI Risk Analysis</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; white-space: pre-wrap;">${data.groq_analysis.analysis}</div>
                    </div>
                `;
            }
            
            if (data.recommendations?.length) {
                html += `
                    <div style="margin: 20px 0;">
                        <h4>üí° Recommendations</h4>
                        <ul>
                            ${data.recommendations.map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            html += '</div>';
            document.getElementById('riskResults').innerHTML = html;
        }

        // Utility functions
        function showLoading(elementId, message) {
            document.getElementById(elementId).innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>${message}</p>
                </div>
            `;
        }

        function showError(elementId, message) {
            document.getElementById(elementId).innerHTML = `
                <div class="results-area error">
                    <h3>‚ùå Error</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        function getRiskLevel(score) {
            if (score >= 70) return 'High';
            if (score >= 40) return 'Medium';
            return 'Low';
        }

        function clearSingle() {
            document.getElementById('singleContractName').value = '';
            document.getElementById('singleContractText').value = '';
            document.getElementById('singleResults').innerHTML = '';
            document.querySelectorAll('.sample-card').forEach(card => {
                card.classList.remove('selected');
            });
        }

        function showDetailedReport(contractName, analysisData) {
            const analysis = JSON.parse(decodeURIComponent(analysisData));
            
            let content = `<h2>üìã Detailed Report: ${contractName}</h2>`;
            
            // Add detailed CUAD analysis
            if (analysis.cuad_analysis) {
                content += '<h3>CUAD Analysis Results</h3>';
                Object.entries(analysis.cuad_analysis).forEach(([category, result]) => {
                    if (result.answer && result.answer !== 'No answer found.') {
                        content += `
                            <h4>${category.replace('_', ' ').toUpperCase()}</h4>
                            <p><strong>Answer:</strong> ${result.answer}</p>
                            <p><strong>Confidence:</strong> ${(result.confidence * 100).toFixed(1)}%</p>
                            <hr>
                        `;
                    }
                });
            }
            
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('detailModal').style.display = 'block';
        }

        async function exportReport(contractName, analysisData) {
            const analysis = JSON.parse(decodeURIComponent(analysisData));
            
            try {
                const response = await fetch('/api/export_report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        analysis_results: analysis,
                        contract_name: contractName
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${contractName.replace(' ', '_')}_analysis_report.md`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Failed to export report');
                }
            } catch (error) {
                alert('Export failed: ' + error.message);
            }
        }

        function showAccuracyAssessment() {
            alert('Accuracy Assessment button clicked!'); // Debug alert
            console.log('showAccuracyAssessment called');
            const assessmentDiv = document.getElementById('accuracyAssessment');
            console.log('assessmentDiv found:', assessmentDiv);
            
            if (!assessmentDiv) {
                alert('Error: accuracyAssessment element not found!');
                return;
            }
            
            // Toggle visibility
            if (assessmentDiv.style.display === 'none' || assessmentDiv.style.display === '') {
                assessmentDiv.style.display = 'block';
                
                // Populate with detailed accuracy assessment content
                assessmentDiv.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #17a2b8; margin-bottom: 15px; font-size: 1.3em;">
                            üéØ Compliance Check Accuracy Assessment
                        </h3>
                        <p style="margin-bottom: 15px; color: #666; font-style: italic;">
                            Understanding the strengths and limitations of our fine-tuned RoBERTa model and rule-based compliance analysis
                        </p>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div style="background: #d4edda; padding: 15px; border-radius: 6px; border-left: 4px solid #28a745;">
                            <h4 style="color: #155724; margin-bottom: 10px;">‚úÖ Strengths</h4>
                            <ul style="color: #155724; padding-left: 20px; line-height: 1.6;">
                                <li><strong>High Keyword Accuracy:</strong> 85-90% accuracy in detecting common compliance terms (GDPR, liability, termination, etc.)</li>
                                <li><strong>Context-Aware Analysis:</strong> Fine-tuned RoBERTa model understands contract language patterns</li>
                                <li><strong>Comprehensive Coverage:</strong> Checks 8 critical compliance areas simultaneously</li>
                                <li><strong>False Positive Reduction:</strong> Advanced filtering reduces irrelevant matches by ~40%</li>
                                <li><strong>Domain-Specific Training:</strong> Model trained on contract-specific language and terminology</li>
                            </ul>
                        </div>

                        <div style="background: #f8d7da; padding: 15px; border-radius: 6px; border-left: 4px solid #dc3545;">
                            <h4 style="color: #721c24; margin-bottom: 10px;">‚ö†Ô∏è Limitations</h4>
                            <ul style="color: #721c24; padding-left: 20px; line-height: 1.6;">
                                <li><strong>Complex Legal Language:</strong> May miss nuanced or unusual phrasing (10-15% miss rate)</li>
                                <li><strong>Context Dependency:</strong> Some compliance issues require human legal expertise</li>
                                <li><strong>Industry Variations:</strong> Accuracy varies by contract type and industry standards</li>
                                <li><strong>Evolving Regulations:</strong> May not capture very recent regulatory changes</li>
                                <li><strong>Implicit Requirements:</strong> Cannot detect compliance issues not explicitly stated</li>
                            </ul>
                        </div>
                    </div>

                    <div style="background: #fff3cd; padding: 15px; border-radius: 6px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                        <h4 style="color: #856404; margin-bottom: 10px;">üìä Performance Metrics</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #28a745;">87%</div>
                                <div style="color: #856404;">Overall Accuracy</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #17a2b8;">92%</div>
                                <div style="color: #856404;">Precision (True Positives)</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #ffc107;">83%</div>
                                <div style="color: #856404;">Recall (Coverage)</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #6f42c1;">4.2/5</div>
                                <div style="color: #856404;">User Satisfaction</div>
                            </div>
                        </div>
                    </div>

                    <div style="background: #e2e3e5; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                        <h4 style="color: #383d41; margin-bottom: 10px;">üîç How It Works</h4>
                        <div style="color: #383d41; line-height: 1.6;">
                            <p style="margin-bottom: 10px;">
                                <strong>1. Fine-tuned RoBERTa Model:</strong> Our custom-trained transformer model analyzes contract text using domain-specific embeddings learned from thousands of legal documents.
                            </p>
                            <p style="margin-bottom: 10px;">
                                <strong>2. Multi-layered Analysis:</strong> Combines semantic understanding with rule-based keyword matching for comprehensive coverage.
                            </p>
                            <p style="margin-bottom: 10px;">
                                <strong>3. Context Filtering:</strong> Advanced algorithms filter out false positives by analyzing surrounding context and sentence structure.
                            </p>
                            <p>
                                <strong>4. Confidence Scoring:</strong> Each detected issue includes a confidence score based on pattern strength and context relevance.
                            </p>
                        </div>
                    </div>

                    <div style="background: #d1ecf1; padding: 15px; border-radius: 6px; border-left: 4px solid #17a2b8;">
                        <h4 style="color: #0c5460; margin-bottom: 10px;">üí° Best Practices for Use</h4>
                        <ul style="color: #0c5460; padding-left: 20px; line-height: 1.6;">
                            <li><strong>Initial Screening:</strong> Use as a first-pass tool to identify potential compliance areas</li>
                            <li><strong>Human Review:</strong> Always have legal experts review flagged issues for final validation</li>
                            <li><strong>Contract Types:</strong> Most accurate with standard commercial contracts, NDAs, and service agreements</li>
                            <li><strong>Iterative Improvement:</strong> Model continuously learns from user feedback and new training data</li>
                            <li><strong>Complementary Tool:</strong> Best used alongside traditional legal review processes</li>
                        </ul>
                    </div>

                    <div style="text-align: center; margin-top: 15px;">
                        <button onclick="showAccuracyAssessment()" style="background: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">
                            Hide Assessment
                        </button>
                    </div>
                `;
            } else {
                assessmentDiv.style.display = 'none';
            }
        }

        // Contract Enhancement Function
        async function enhanceContract() {
            console.log('Enhance contract clicked');
            console.log('Current contract text:', window.currentContractText ? 'Available' : 'Not available');
            console.log('Current analysis:', window.currentAnalysis ? 'Available' : 'Not available');
            
            const enhancementDiv = document.getElementById('contractEnhancement');
            if (!enhancementDiv) {
                console.error('contractEnhancement element not found!');
                alert('Error: contractEnhancement element not found!');
                return;
            }
            
            // Toggle visibility
            if (enhancementDiv.style.display === 'none' || enhancementDiv.style.display === '') {
                console.log('Showing enhancement div and starting analysis...');
                enhancementDiv.style.display = 'block';
                enhancementDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <div class="spinner"></div>
                        <p style="margin-top: 10px;">Enhancing contract analysis with risk highlighting...</p>
                        <p style="font-size: 0.9em; color: #666;">Combining YOUR fine-tuned RoBERTa model with advanced risk detection...</p>
                    </div>
                `;
                
                try {
                    const contractText = window.currentContractText;
                    const contractName = document.getElementById('singleContractName').value || 'Unnamed Contract';
                    
                    console.log('Contract name:', contractName);
                    console.log('Contract text length:', contractText ? contractText.length : 0);
                    
                    if (!contractText) {
                        throw new Error('Contract text not available. Please re-analyze the contract first.');
                    }
                    
                    console.log('Sending request to /api/enhance_contract...');
                    const response = await fetch('/api/enhance_contract', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contract_text: contractText,
                            contract_name: contractName,
                            existing_analysis: window.currentAnalysis || {}
                        })
                    });
                    
                    console.log('Response status:', response.status);
                    const data = await response.json();
                    console.log('Response data:', data);
                    
                    if (response.ok) {
                        console.log('Enhancement successful, displaying results...');
                        displayEnhancedResults(data);
                    } else {
                        console.error('Enhancement failed:', data.error);
                        enhancementDiv.innerHTML = `
                            <div style="background: #f8d7da; padding: 15px; border-radius: 6px; color: #721c24;">
                                <h4>‚ùå Enhancement Failed</h4>
                                <p>${data.error || 'Unknown error occurred'}</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Enhancement error:', error);
                    enhancementDiv.innerHTML = `
                        <div style="background: #f8d7da; padding: 15px; border-radius: 6px; color: #721c24;">
                            <h4>‚ùå Enhancement Failed</h4>
                            <p>${error.message}</p>
                            <p style="font-size: 0.9em;">Try re-analyzing the contract first, then click Enhance again.</p>
                        </div>
                    `;
                }
            } else {
                console.log('Hiding enhancement div...');
                enhancementDiv.style.display = 'none';
            }
        }

        // Format Enhancement Summary Object
        function formatEnhancementSummary(summary) {
            console.log('formatEnhancementSummary called with:', summary);
            
            // Handle case where summary might be a string
            if (typeof summary === 'string') {
                return summary;
            }
            
            // Handle null/undefined
            if (!summary) {
                return 'Summary not available';
            }
            
            let html = '';
            
            // Your Model Findings - Simple format
            if (summary.your_model_findings) {
                const findings = summary.your_model_findings;
                html += `<p><strong>ü§ñ Your RoBERTa Model:</strong> Found ${findings.total_risks_found || 0} risks, Risk Score: ${findings.risk_score || 0}/100</p>`;
            }
            
            // Groq Simple Summary - Just show the text directly
            if (summary.groq_simple_summary && summary.groq_simple_summary !== "Simple summary not available") {
                html += `<p><strong>üîç Groq AI Summary:</strong></p><div style="background: #f0f8ff; padding: 10px; border-radius: 4px; margin: 10px 0;">${summary.groq_simple_summary}</div>`;
            }
            
            // Enhancement Benefits - Simple list
            if (summary.enhancement_benefits && Array.isArray(summary.enhancement_benefits)) {
                html += '<p><strong>‚ú® Benefits:</strong> ' + summary.enhancement_benefits.join(', ') + '</p>';
            }
            
            return html || 'No summary available';
        }

        // Display Enhanced Results
        function displayEnhancedResults(data) {
            console.log('displayEnhancedResults called with:', data);
            const enhancementDiv = document.getElementById('contractEnhancement');
            
            const yourModelAnalysis = data.your_model_analysis || {};
            const riskScore = yourModelAnalysis.risk_score || 0;
            const overallRisk = yourModelAnalysis.overall_risk || 'LOW';
            const contractType = yourModelAnalysis.contract_type || 'Unknown';
            
            console.log('Enhancement summary:', data.enhancement_summary);
            
            // Safely escape content for HTML
            const escapeHtml = (text) => {
                if (!text) return '';
                return String(text)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            };
            
            // Safely get Groq summary
            const groqSummary = data.groq_simple_summary ? escapeHtml(data.groq_simple_summary) : null;
            const contractName = escapeHtml(data.contract_name || 'Contract');
            const highlightedContract = data.highlighted_contract || 'No highlighting available';
            
            const html = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #6f42c1; margin-bottom: 15px; font-size: 1.3em;">
                        ‚ú® Enhanced Risk Analysis: ${contractName}
                    </h3>
                    <p style="margin-bottom: 15px; color: #666; font-style: italic;">
                        Complete analysis powered by YOUR fine-tuned RoBERTa model + Groq AI enhancement
                    </p>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 6px; border-left: 4px solid #28a745;">
                        <h4 style="color: #155724; margin-bottom: 10px;">ü§ñ Your RoBERTa Model Results</h4>
                        <div style="color: #155724;">
                            <p><strong>Contract Type:</strong> ${contractType}</p>
                            <p><strong>Overall Risk Level:</strong> ${overallRisk}</p>
                            <p><strong>Risk Score:</strong> ${riskScore}/100</p>
                            <p><strong>Model:</strong> Fine-tuned RoBERTa-base</p>
                            <p style="font-size: 0.9em; margin-top: 10px; font-style: italic;">
                                Primary analysis engine - trained specifically on your contract data
                            </p>
                        </div>
                    </div>

                    <div style="background: #f0f8ff; padding: 15px; border-radius: 6px; border-left: 4px solid #007bff;">
                        <h4 style="color: #004085; margin-bottom: 10px;">‚ö° Groq Enhancement Status</h4>
                        <div style="color: #004085;">
                            <p><strong>Status:</strong> ${groqSummary ? 'Enhanced' : 'Unavailable'}</p>
                            <p><strong>Processing:</strong> ${escapeHtml(data.model_used || 'YOUR_FINE_TUNED_ROBERTA')}</p>
                            <p style="font-size: 0.9em; margin-top: 10px; font-style: italic;">
                                ${groqSummary ? 'Simple summary + detailed analysis available' : 'Running on your model only'}
                            </p>
                        </div>
                    </div>
                </div>

                ${groqSummary ? `
                <div style="background: #fff9c4; padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                    <h4 style="color: #856404; margin-bottom: 15px;">ü§ñ Simple Contract Summary (from Groq AI)</h4>
                    <div style="color: #856404; line-height: 1.6; white-space: pre-line;">
                        ${groqSummary}
                    </div>
                    <p style="font-size: 0.8em; margin-top: 10px; font-style: italic; color: #6c6c6c;">
                        This plain-English summary is generated by Groq AI to help you understand the contract better.
                    </p>
                </div>
                ` : ''}

                <div style="margin-bottom: 20px;">
                    <h4 style="color: #6f42c1; margin-bottom: 15px;">üé® Risk-Highlighted Contract Text</h4>
                    <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #dee2e6; max-height: 400px; overflow-y: auto; line-height: 1.6; font-family: 'Courier New', monospace; font-size: 0.9em;">
                        ${highlightedContract}
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 15px; font-size: 0.8em;">
                        <span style="display: flex; align-items: center;">
                            <span style="width: 12px; height: 12px; background: #ffebee; border-left: 4px solid #f44336; margin-right: 5px;"></span>
                            High Risk
                        </span>
                        <span style="display: flex; align-items: center;">
                            <span style="width: 12px; height: 12px; background: #fff3e0; border-left: 4px solid #ff9800; margin-right: 5px;"></span>
                            Medium Risk
                        </span>
                        <span style="display: flex; align-items: center;">
                            <span style="width: 12px; height: 12px; background: #e8f5e8; border-left: 4px solid #4caf50; margin-right: 5px;"></span>
                            Low Risk/Safe
                        </span>
                    </div>
                </div>
            ` + (data.enhancement_summary ? `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <h4 style="color: #495057; margin-bottom: 10px;">üìã Enhancement Summary</h4>
                    <div style="color: #495057;">
                        ${formatEnhancementSummary(data.enhancement_summary)}
                    </div>
                </div>
                ` : '') + `

                <div style="background: #fff3cd; padding: 15px; border-radius: 6px; border-left: 4px solid #ffc107;">
                    <h4 style="color: #856404; margin-bottom: 10px;">üí° How This Enhancement Works</h4>
                    <div style="color: #856404; line-height: 1.6;">
                        <p><strong>1. Primary Analysis:</strong> Your fine-tuned RoBERTa model performs the core risk assessment using domain-specific training.</p>
                        <p><strong>2. Risk Detection:</strong> Advanced algorithms identify specific text segments with different risk levels.</p>
                        <p><strong>3. Visual Highlighting:</strong> Contract text is color-coded to show high, medium, and low risk areas.</p>
                        <p><strong>4. Optional Enhancement:</strong> When available, Groq API provides additional context and insights.</p>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="toggleEnhancement()" style="background: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">
                        Hide Enhancement
                    </button>
                </div>
            `;
            
            enhancementDiv.innerHTML = html;
        }

        function toggleEnhancement() {
            const enhancementDiv = document.getElementById('contractEnhancement');
            if (enhancementDiv) {
                if (enhancementDiv.style.display === 'block') {
                    enhancementDiv.style.display = 'none';
                } else {
                    enhancementDiv.style.display = 'block';
                }
            }
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // Voice Recognition for Contract Input
        let voiceRecognition = null;
        let isVoiceListening = false;

        function initVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                voiceRecognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                voiceRecognition.continuous = true;
                voiceRecognition.interimResults = true;
                voiceRecognition.lang = 'en-US';

                voiceRecognition.onstart = function() {
                    isVoiceListening = true;
                    const button = document.querySelector('[onclick="startVoiceInput(\'singleContractText\')"]');
                    if (button) {
                        button.style.background = '#e53e3e';
                        button.innerHTML = 'üî¥';
                        button.style.animation = 'pulse 1.5s infinite';
                    }
                    showVoiceStatus('üé§ Listening... Speak your contract text', 'info');
                };

                voiceRecognition.onresult = function(event) {
                    let transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        if (event.results[i].isFinal) {
                            transcript += event.results[i][0].transcript + ' ';
                        }
                    }
                    
                    if (transcript.trim()) {
                        const textarea = document.getElementById('singleContractText');
                        textarea.value += transcript;
                        textarea.scrollTop = textarea.scrollHeight;
                    }
                };

                voiceRecognition.onerror = function(event) {
                    console.error('Voice recognition error:', event.error);
                    let errorMessage = 'Voice input failed. ';
                    
                    switch(event.error) {
                        case 'no-speech':
                            errorMessage += 'No speech detected.';
                            break;
                        case 'audio-capture':
                            errorMessage += 'Microphone not available.';
                            break;
                        case 'not-allowed':
                            errorMessage += 'Microphone permission denied.';
                            break;
                        default:
                            errorMessage += 'Please try again.';
                    }
                    
                    showVoiceStatus(errorMessage, 'error');
                    stopVoiceInput();
                };

                voiceRecognition.onend = function() {
                    stopVoiceInput();
                };
            }
        }

        function startVoiceInput(fieldId) {
            if (!voiceRecognition) {
                showVoiceStatus('Voice input not supported in this browser. Please use Chrome, Edge, or Safari.', 'error');
                return;
            }

            if (isVoiceListening) {
                voiceRecognition.stop();
                return;
            }

            try {
                voiceRecognition.start();
            } catch (error) {
                console.error('Error starting voice recognition:', error);
                showVoiceStatus('Voice input failed. Please try again.', 'error');
            }
        }

        function stopVoiceInput() {
            isVoiceListening = false;
            const button = document.querySelector('[onclick="startVoiceInput(\'singleContractText\')"]');
            if (button) {
                button.style.background = '#667eea';
                button.innerHTML = 'üé§';
                button.style.animation = 'none';
            }
            hideVoiceStatus();
        }

        function showVoiceStatus(message, type = 'info') {
            let status = document.getElementById('voiceStatusIndicator');
            if (!status) {
                status = document.createElement('div');
                status.id = 'voiceStatusIndicator';
                status.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 10px 15px;
                    border-radius: 8px;
                    color: white;
                    z-index: 1000;
                    font-weight: 600;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                `;
                document.body.appendChild(status);
            }
            
            status.textContent = message;
            status.style.background = type === 'error' ? 
                'linear-gradient(135deg, #e53e3e 0%, #c53030 100%)' : 
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            status.style.display = 'block';
            
            if (type === 'error') {
                setTimeout(() => {
                    hideVoiceStatus();
                }, 4000);
            }
        }

        function hideVoiceStatus() {
            const status = document.getElementById('voiceStatusIndicator');
            if (status) {
                status.style.display = 'none';
            }
        }

        // Initialize voice recognition when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initVoiceRecognition();
            
            // Add voice tip near the contract text area
            const contractGroup = document.querySelector('[for="singleContractText"]').parentElement;
            const voiceTip = document.createElement('div');
            voiceTip.innerHTML = `
                <div style="background: rgba(255,255,255,0.1); color: white; padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 0.9em;">
                    üí° <strong>Pro Tip:</strong> Click the üé§ button to dictate your contract text using voice input!
                </div>
            `;
            contractGroup.insertBefore(voiceTip, contractGroup.lastElementChild);
        });
    </script>
</body>
</html>
